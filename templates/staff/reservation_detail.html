{% extends "staff/base_staff.html" %}
{% set title = "予約詳細" %}

{% block content %}
<section class="card">
  {% if not_found %}
    <h1 class="h1">見つかりません</h1>
  {% else %}
    <h1 class="h1">予約 #{{ r.id }}</h1>

    <div class="grid">
      <div>
        <h2 class="h2">患者入力</h2>
        <div class="kv"><div>氏名</div><div>{{ r.patient_name }}</div></div>
        <div class="kv"><div>メール</div><div>{{ r.email }}</div></div>
        <div class="kv"><div>希望日1</div><div>{{ r.preferred_date1 or "-" }}</div></div>
        <div class="kv"><div>希望日2</div><div>{{ r.preferred_date2 or "-" }}</div></div>
        <div class="kv"><div>希望日3</div><div>{{ r.preferred_date3 or "-" }}</div></div>
        <div class="kv"><div>希望帯</div><div>{{ r.preferred_time or "-" }}</div></div>
        <div class="kv"><div>備考</div><div>{{ r.note or "-" }}</div></div>
        <div class="kv"><div>状態</div><div><strong>{{ r.status }}</strong></div></div>
      </div>

      <div>
        <h2 class="h2">確定入力</h2>

        {% if error %}
          <div class="alert" role="alert">{{ error }}</div>
        {% endif %}

        <form method="post" action="{{ url_for('staff.confirm', reservation_id=r.id) }}" class="form">
          <label class="label" for="confirmed_datetime">確定日時（必須）</label>
          <input class="input" id="confirmed_datetime" name="confirmed_datetime" type="text"
                 placeholder="例：2025-12-20 10:30" value="{{ r.confirmed_datetime or '' }}" required>

          <label class="label" for="confirmed_note">案内（任意）</label>
          <textarea class="textarea" id="confirmed_note" name="confirmed_note" rows="5"
            placeholder="例：初診のため保険証をご持参ください。">{{ r.confirmed_note or '' }}</textarea>

          <label class="label" for="confirmed_by">確定者（任意）</label>
          <input class="input" id="confirmed_by" name="confirmed_by" type="text" value="{{ r.confirmed_by or '' }}">

          <button class="button" type="submit">確定してメール送信</button>
        </form>

        {% if r.confirm_email_body %}
          <details class="box">
            <summary>送信内容（控え）</summary>
            <pre class="pre">{{ r.confirm_email_body }}</pre>
          </details>
        {% endif %}
      </div>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block title %}予約詳細 #{{ reservation.id }}{% endblock %}

{% block content %}

<h2>予約詳細</h2>

<p style="margin: .5rem 0 1.5rem;">
  <a href="{{ url_for('staff.reservation_list') }}">← 一覧に戻る</a>
</p>

<section class="card">
  <h3>患者情報</h3>
  <table class="detail-table">
    <tr><th>ID</th><td>{{ reservation.id }}</td></tr>
    <tr><th>メール</th><td>{{ reservation.email }}</td></tr>
    <tr><th>診察券番号</th><td>{{ reservation.chart_number or "-" }}</td></tr>
    <tr><th>紹介元医療機関</th><td>{{ reservation.referring_hospital or "-" }}</td></tr>
    <tr><th>氏名</th><td>{{ reservation.last_name }} {{ reservation.first_name }}</td></tr>
    <tr><th>氏名カナ</th><td>{{ (reservation.last_name_kana or "") ~ " " ~ (reservation.first_name_kana or "") }}</td></tr>
    <tr><th>生年月日</th><td>{{ reservation.birth_date or "-" }}</td></tr>
    <tr><th>性別</th><td>{{ reservation.sex or "-" }}</td></tr>
    <tr><th>受付日時</th><td>{{ reservation.created_at }}</td></tr>
    <tr><th>更新日時</th><td>{{ reservation.updated_at }}</td></tr>
  </table>
</section>

<section class="card">
  <h3>希望日時</h3>
  <table class="detail-table">
    <tr>
      <th>第1希望</th>
      <td>{{ reservation.first_choice_date or "-" }} / {{ reservation.first_choice_time_slot or "-" }}</td>
    </tr>
    <tr>
      <th>第2希望</th>
      <td>{{ reservation.second_choice_date or "-" }} / {{ reservation.second_choice_time_slot or "-" }}</td>
    </tr>
    <tr>
      <th>第3希望</th>
      <td>{{ reservation.third_choice_date or "-" }} / {{ reservation.third_choice_time_slot or "-" }}</td>
    </tr>
  </table>
</section>

<section class="card">
  <h3>職員対応（更新フォーム）</h3>

  {# flashメッセージ表示 #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-area">
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" class="staff-form">
    <div class="form-row">
      <label for="status">ステータス</label>
      <select id="status" name="status" required>
        <option value="" {% if not reservation.status %}selected{% endif %}>選択してください</option>
        <option value="pending" {% if reservation.status == "pending" %}selected{% endif %}>未処理（pending）</option>
        <option value="confirmed" {% if reservation.status == "confirmed" %}selected{% endif %}>確定（confirmed）</option>
        <option value="need_reschedule" {% if reservation.status == "need_reschedule" %}selected{% endif %}>再調整（need_reschedule）</option>
        <option value="cancelled" {% if reservation.status == "cancelled" %}selected{% endif %}>キャンセル（cancelled）</option>
      </select>
    </div>

    <div class="form-row">
      <label for="confirmed_datetime">確定日時（任意）</label>
      <input
        id="confirmed_datetime"
        name="confirmed_datetime"
        type="text"
        placeholder="例：2026-01-15 14:30 など"
        value="{{ reservation.confirmed_datetime or '' }}"
      >
      <small class="hint">確定の場合のみ入力する想定です（SQLiteは文字列で保存）。</small>
    </div>

    <div class="form-row">
      <label for="handled_by">対応者（任意）</label>
      <input
        id="handled_by"
        name="handled_by"
        type="text"
        placeholder="例：南、榎本 など"
        value="{{ reservation.handled_by or '' }}"
      >
    </div>

    <div class="form-row">
      <label for="staff_note">職員メモ（任意）</label>
      <textarea
        id="staff_note"
        name="staff_note"
        rows="4"
        placeholder="再調整理由、患者さんへの連絡内容など"
      >{{ reservation.staff_note or '' }}</textarea>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">更新する</button>
      <a class="btn-secondary" href="{{ url_for('staff.reservation_list') }}">一覧へ戻る</a>
    </div>
  </form>
</section>

{% endblock %}
